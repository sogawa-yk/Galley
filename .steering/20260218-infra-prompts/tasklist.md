# タスクリスト

## 🚨 タスク完全完了の原則

**このファイルの全タスクが完了するまで作業を継続すること**

### 必須ルール
- **全てのタスクを`[x]`にすること**
- 「時間の都合により別タスクとして実施予定」は禁止
- 「実装が複雑すぎるため後回し」は禁止
- 未完了タスク（`[ ]`）を残したまま作業を終了しない

### 実装可能なタスクのみを計画
- 計画段階で「実装可能なタスク」のみをリストアップ
- 「将来やるかもしれないタスク」は含めない
- 「検討中のタスク」は含めない

### タスクスキップが許可される唯一のケース
以下の技術的理由に該当する場合のみスキップ可能:
- 実装方針の変更により、機能自体が不要になった
- アーキテクチャ変更により、別の実装方法に置き換わった
- 依存関係の変更により、タスクが実行不可能になった

スキップ時は必ず理由を明記:
```markdown
- [x] ~~タスク名~~（実装方針変更により不要: 具体的な技術的理由）
```

### タスクが大きすぎる場合
- タスクを小さなサブタスクに分割
- 分割したサブタスクをこのファイルに追加
- サブタスクを1つずつ完了させる

---

## フェーズ1: プロンプト実装

- [x] `src/galley/prompts/infra.py` を作成
  - [x] `register_infra_prompts(mcp)` 関数を定義
  - [x] `terraform_debug_loop(session_id)` プロンプトを実装
  - [x] `oci_resource_check()` プロンプトを実装
  - [x] `infra_cleanup(session_id)` プロンプトを実装

## フェーズ2: サーバー登録

- [x] `server.py` にインフラプロンプト登録を追加
  - [x] `register_infra_prompts` のインポート
  - [x] インフラ層セクションに `register_infra_prompts(mcp)` を追加

## フェーズ3: テスト

- [x] `tests/integration/test_infra_flow.py` にプロンプト登録テストを追加

## フェーズ4: 品質チェック

- [x] `uv run pytest` — 141 passed（プロンプト内容検証テスト3件追加後）
- [x] `uv run ruff check .` — All checks passed
- [x] `uv run mypy src/galley/prompts/infra.py src/galley/server.py` — Success: no issues found
- [x] `uv run ruff format --check .` — 50 files already formatted

---

## 実装後の振り返り

### 実装完了日
2026-02-19

### 計画と実績の差分

**計画と異なった点**:
- バリデータの指摘により、プロンプト登録確認テストだけでなく、引数付きプロンプトの内容検証テスト3件を追加。テストカバレッジが向上した。
- `oci_resource_check` のdocstringに利用文脈（Terraform apply後のリソース確認、デバッグ時の調査）を追記
- `infra_cleanup` のplan実行ステップの説明文を「削除対象のリソース一覧を確認」に改善

**新たに必要になったタスク**:
- プロンプト内容検証テスト追加（バリデータ推奨事項への対応）

**技術的理由でスキップしたタスク**:
- なし（全タスク完了）

### 学んだこと

**技術的な学び**:
- FastMCPの`client.get_prompt(name, args)`でプロンプトの返却テキストを検証できる。`result.messages[0].content.text`でテキストにアクセス。
- MCPプロンプトは引数なし（`oci_resource_check`）と引数あり（`terraform_debug_loop`, `infra_cleanup`）の両パターンを使い分けられる
- プロンプト内容にツール名を明示的に記載することで、LLMが適切なツール呼び出しを行える

**プロセス上の改善点**:
- 既存パターン（hearing.py, design.py）の調査が実装の方向性を明確にし、迷いなく進められた
- バリデータによるテスト不足の指摘が品質向上に直結した

### 次回への改善提案
- プロンプト実装時は、機能設計書のユースケース図と1対1で対応させることで設計の整合性を保てる
- 引数付きプロンプトには必ず内容検証テストを書く（登録確認だけでは不十分）
