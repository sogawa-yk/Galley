# タスクリスト

## 🚨 タスク完全完了の原則

**このファイルの全タスクが完了するまで作業を継続すること**

### 必須ルール
- **全てのタスクを`[x]`にすること**
- 「時間の都合により別タスクとして実施予定」は禁止
- 「実装が複雑すぎるため後回し」は禁止
- 未完了タスク（`[ ]`）を残したまま作業を終了しない

### 実装可能なタスクのみを計画
- 計画段階で「実装可能なタスク」のみをリストアップ
- 「将来やるかもしれないタスク」は含めない
- 「検討中のタスク」は含めない

### タスクスキップが許可される唯一のケース
以下の技術的理由に該当する場合のみスキップ可能:
- 実装方針の変更により、機能自体が不要になった
- アーキテクチャ変更により、別の実装方法に置き換わった
- 依存関係の変更により、タスクが実行不可能になった

スキップ時は必ず理由を明記:
```markdown
- [x] ~~タスク名~~（実装方針変更により不要: 具体的な技術的理由）
```

### タスクが大きすぎる場合
- タスクを小さなサブタスクに分割
- 分割したサブタスクをこのファイルに追加
- サブタスクを1つずつ完了させる

---

## フェーズ1: ツール追加・プロンプト修正

- [x] `src/galley/tools/hearing.py` の `register_hearing_tools` に `config_dir` キーワード引数を追加
- [x] `get_hearing_questions` ツールを実装（`config/hearing-questions.yaml` をdictで返却）
- [x] `get_hearing_flow` ツールを実装（`config/hearing-flow.yaml` をdictで返却）
- [x] `src/galley/server.py` の `register_hearing_tools` 呼び出しに `config_dir=config.config_dir` を追加
- [x] `src/galley/prompts/hearing.py` の `start_hearing` をリソース参照→ツール参照に変更
- [x] `src/galley/prompts/hearing.py` の `resume_hearing` をリソース参照→ツール参照に変更

## フェーズ2: テスト・検証

- [x] pytest全テスト実行 → 87件全パス確認
- [x] ローカルでツール数17を確認（`create_server()` → `get_tools()`）
- [x] コミット＆gitプッシュ
- [x] Dockerイメージビルド＆OCIRプッシュ
- [x] Container Instance再起動
- [x] リモートエンドポイントでtools/list → 17ツール返却を確認

## フェーズ3: Claude Desktop動作確認（ユーザー実施）

- [x] Claude Desktopで再接続し、17ツールが表示されることを確認
- [x] `start_hearing` プロンプトでヒアリング開始 → 「リソースにアクセスできない」エラーが出ないことを確認

---

## 実装後の振り返り

### 実装完了日
2026-02-18

### 計画と実績の差分

**計画と異なった点**:
- 特になし。小規模な変更のため計画通りに実装完了

### 学んだこと

**技術的な学び**:
- Claude DesktopはMCPリソース（`resource://`）の自動読み取りをサポートしていない。プロンプトからリソースを参照しても、Claudeはリソースにアクセスできない
- MCPツールはClaude Desktopで完全にサポートされており、プロンプトからツール呼び出しを指示するのが最も確実
- リソースとツールは並存可能。リソース対応クライアント向けにリソースを残しつつ、ツールで同等の機能を提供できる
- FastMCPのツール関数は `dict` を返せばJSON直列化される。YAMLをstringで返すリソースとは異なりパース済みデータを返すのが自然

**プロセス上の改善点**:
- ユーザーのフィードバック（「リソースにアクセスできない」メッセージ）から即座に原因特定→修正→デプロイまで完了できた

### 次回への改善提案
- 新しいMCPプロンプトを作成する際は、リソース参照ではなくツール呼び出しを使用する（Claude Desktop互換性のため）
- 設計層にも同様のリソース参照がある場合は、同じパターンでツール化を検討する
