# OKE API Server (port 6443) Security List ルール欠落

**テスト実施日**: 2026-02-27
**テストツール**: mcp-gauge (E2Eフルデプロイテスト)
**テスト環境**: ap-osaka-1

---

## テスト概要

E2Eフルデプロイテスト（VCN + OKE構成）において、Terraform apply成功後に `build_and_deploy` でkubectl applyが失敗。原因はPublic Security ListにOKE Kubernetes API Server (port 6443) への外部アクセスルールが生成されないこと。

---

## 問題1: Public Security ListにOKE API Server (port 6443) のルールが欠落

**重要度**: Critical
**対象ファイル**: `src/galley/services/design.py`（Security List Terraform生成部分）

**症状**: OKEクラスタのAPIサーバーエンドポイントはPublic Subnetに配置され、port 6443でリッスンする。しかし、生成されるPublic Security Listのingressルールには port 443 (HTTPS) のみが含まれ、port 6443 が含まれない。この結果、外部（Galleyサーバーやローカル環境）からkubectlでクラスタに接続できず、`build_and_deploy` の kubectl apply が `dial tcp <IP>:6443: i/o timeout` で失敗する。

**再現手順**:
1. VCN + OKE構成で `save_architecture`
2. `export_iac` を実行
3. 生成された `components.tf` のPublic Security Listにport 6443のingressルールがない
4. Terraform apply後、`build_and_deploy` でkubectl接続がタイムアウト

**期待動作**: OKEコンポーネントが存在する場合、Public Security Listに以下のingressルールを追加する:
- Ingress: TCP port 6443 from 0.0.0.0/0（Kubernetes API Server）

**回避策**: OCI CLIでPublic Security Listに手動でport 6443ルールを追加。

---

## 補足

- 前回のE2Eテスト（20260226-e2e-full-deploy.md）で追加したOKE用Security Listルール（全TCP from VCN CIDR、ICMP Type 3 Code 4）はノード間通信には有効だったが、外部からのAPI Server接続は考慮されていなかった。
- OKEクラスタの `endpoint_config.is_public_ip_enabled = true` でPublic Endpointが有効化されているため、外部からのアクセスを前提としたルールが必要。

---

## 対応結果
- **対応日**: 2026-02-27
- **ステアリング**: `.steering/20260227-oke-api-port6443-fix/`
- **対応内容の要約**: design.pyの`_expand_vcn_network`でOKE追加ルールをPublic/Private別に分離。Public SLにTCP 6443 from 0.0.0.0/0ルールを追加（Private SLには追加しない）。テスト2件追加（290件全パス）。
- **E2Eスモークテスト**: PASSED（VCN+OKE構成でplan成功、7ツール呼出・0エラー）
