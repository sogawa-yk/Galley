# Galley MCP サーバー フィードバックレポート

**日時:** 2026-02-26  
**セッション:** OKE + MySQL + TODO Web App フルスタックデプロイ  
**Session ID:** `e8ed36cb-403d-4a4f-98fc-c6d11e29f8b8`  
**利用者:** Claude（AIエージェントとして）

---

## 総合評価

ヒアリング → アーキテクチャ設計 → IaC生成 → Resource Manager経由のプロビジョニング → アプリスキャフォールドまで、**1セッションで一気通貫に実行できた**のは非常に強力。プリセールスのデモ構築ワークフローとしてのポテンシャルは高い。一方で、実運用に向けていくつかの改善点が見つかった。

---

## 良かった点

### 1. ヒアリングフローの設計が秀逸
- 質問が構造化されており、AIエージェントが迷わず進行できた
- `save_answers_batch` で一括保存できるのが効率的
- `complete_hearing` → `get_hearing_result` の流れが明確

### 2. Terraform生成 + Resource Manager統合
- `export_iac` → `run_terraform_plan` → `run_terraform_apply` のパイプラインがスムーズ
- RM変数の自動除外（`region`, `compartment_ocid`等）が地味に便利
- `update_terraform_file` でデバッグループ（plan → エラー修正 → 再plan）が回せる

### 3. セッション管理
- session_idベースで状態が保持され、途中のエラーからの復旧が容易
- 前回のApplyで作成済みリソースがstate上に残り、差分のみ追加Applyできた

### 4. テンプレートスキャフォールド
- `scaffold_from_template` → `update_app_code` のワークフローが直感的
- protected_paths の概念でテンプレートのコア部分を保護しつつカスタマイズ可能

---

## 改善すべき点

### 🔴 Critical

#### C1: `build_and_deploy` が未実装
- 最も重要なラストワンマイルが欠けている
- IaC → アプリデプロイまでをエンドツーエンドで完結させることがGalleyの最大の価値なので、最優先で実装すべき
- 提案: OCIR pushはOCI CLI経由、OKEデプロイはkubectl apply（kubeconfigをOCI CLI経由で取得）で実現可能

#### C2: `export_iac` のTerraformテンプレートと実際のapply用テンプレートが乖離
- `export_all` で返されるTerraformコードは初期テンプレート（`update_terraform_file`での修正が未反映）
- セッション中に4回修正したが、exportにはオリジナルのバグ入りコードが返ってくる
- これはユーザーへの成果物として致命的。**exportは常に最新のファイル内容を返すべき**

#### C3: Terraform初期テンプレートの品質
以下のバグがあり、全てAIエージェント側で修正した：
- ノードプールの `subnet_id` がAPIサブネットを指していた（ノードサブネットであるべき）
- セキュリティリストのTCPポートが `min=0, max=0` で無効
- Service Gatewayのサービス選択がリージョン非依存でなかった（`all-nrt-services-...` がハードコード）
- OKEクラスタに `service_lb_subnet_ids` が未設定
- private route tableにService Gatewayルートが未設定

→ テンプレートにリージョン依存のハードコード値を入れない設計にすべき。`data.oci_core_services` からの動的取得をデフォルトにすべき。

### 🟡 Important

#### I1: `save_architecture` のコンポーネントとTerraformの整合性
- アーキテクチャ設計フェーズで保存したコンポーネント（ADB, LB）と、実際にデプロイしたリソース（MySQL DS、LBはOKE Service経由）が異なる状態になった
- アーキテクチャを更新する手段がない（`save_architecture` を再度呼べるが、exportには反映されない可能性）

#### I2: テンプレートが1種類しかない
- `rest-api-adb` のみ。MySQL対応、フロントエンド付き、静的サイト等のバリエーションが欲しい
- 特にADBがテナンシで使えないケースは珍しくないので、MySQL/PostgreSQL対応テンプレートは必須

#### I3: `run_terraform_apply` のタイムアウト
- Applyがlong-running（OKEクラスタ: ~10分、MySQL: ~13分）なので頻繁にタイムアウトする
- 非同期ジョブとして返してくれるのは良いが、`get_rm_job_status` でポーリングするしかない
- 提案: `run_terraform_apply` を非同期で即座にjob_idを返す設計にし、完了時のコールバックやWebhookを検討

#### I4: `get_rm_job_status` のログ取得タイミング
- ジョブがIN_PROGRESSの間、ログが空（`"logs": ""`）で返ることが多い
- 実行中でもストリーミングでログが見られると、エラーの早期発見やユーザーへの進捗報告に役立つ

### 🟢 Nice to Have

#### N1: `validate_architecture` の結果をTerraformに自動反映
- バリデーションで指摘された問題（ノードプールのサブネット等）を自動修正するオプションがあると便利

#### N2: コスト見積もり機能
- ヒアリング完了後やアーキテクチャ確定後に、概算コストを表示する機能
- 今回MySQL有償シェイプに切り替えた際、コスト影響が不明だった

#### N3: `list_available_services` の充実
- 現在利用可能なサービス一覧にMySQL DSが含まれているか不明だった
- テナンシで利用可能なサービスの制約（ADB無効、Free Tierのリージョン制限等）を事前に検出できると良い

#### N4: ロールバック / Destroy のUX
- `run_terraform_destroy` はあるが、部分的なリソース削除やロールバックの仕組みがない
- 今回のようにApply失敗→修正→再Applyのサイクルで、不要リソースが残る可能性

#### N5: K8sマニフェスト生成
- Terraform（インフラ層）だけでなく、K8s Deployment/Service/ConfigMap/Secret のマニフェスト生成もスコープに入れると価値が大きい
- 特にOCIR + OKE連携のマニフェストはボイラープレートが多いので自動化の恩恵が大きい

---

## セッション中に遭遇したエラーと対処

| # | エラー | 原因 | 対処 |
|---|--------|------|------|
| 1 | VCN QuotaExceeded | テナンシのVCN上限 | ユーザーが手動で不要VCN削除 |
| 2 | Service CIDR `all-nrt-services-...` invalid | フランクフルトなのに東京のCIDR名 | `data.oci_core_services` で動的取得に修正 |
| 3 | ADB `IncorrectState` - feature not enabled | テナンシでADB未有効化 | MySQL DSに切り替え |
| 4 | MySQL.Free - home region only | Free TierはホームリージョンIADのみ | 有償シェイプ `MySQL.VM.Standard.E4.1.8GB` に変更 |
| 5 | `build_and_deploy` 未実装 | 機能未開発 | 手動デプロイ手順を案内 |

→ エラー2, 3は**テンプレート品質の改善**で防げる。エラー4は**テナンシ情報の事前チェック**で回避可能。

---

## 提案: 優先度付きロードマップ

| 優先度 | 項目 | 期待効果 |
|--------|------|----------|
| P0 | `build_and_deploy` 実装 | エンドツーエンド完結 |
| P0 | Terraformテンプレートのバグ修正 | 初回Applyの成功率向上 |
| P1 | `export_all` が最新状態を返すよう修正 | 成果物の正確性 |
| P1 | MySQL対応テンプレート追加 | テナンシ制約への対応力 |
| P2 | Apply非同期化 + ログストリーミング | UX改善 |
| P2 | テナンシ制約の事前チェック | エラー回避 |
| P3 | K8sマニフェスト生成 | デプロイ完全自動化 |
| P3 | コスト見積もり | 意思決定支援 |

---

## まとめ

Galleyは「ヒアリング → 設計 → IaC → プロビジョニング → アプリデプロイ」というプリセールスワークフローを自動化する野心的なプロジェクト。現時点でヒアリング〜プロビジョニングまでは十分に動作しており、Terraformのデバッグループも回せる。`build_and_deploy` の実装とテンプレート品質の向上が実現すれば、プリセールスデモ構築の工数を大幅に削減できるポテンシャルがある。

---
## 対応結果
- **対応日**: 2026-02-26
- **ステアリング**: `.steering/20260226-fullstack-deploy-feedback/`
- **対応内容の要約**: C2（`export_all`がterraform_dirの実ファイルを読み込んで最新内容を返すよう修正）、C3（Service Gatewayのregexフィルタ、public/private双方のroute_table/security_list/subnet生成、OKEの`service_lb_subnet_ids`追加・node_poolのprivateサブネット参照、セキュリティリストのport=0ガード、private route tableへのService Gatewayルート追加）を修正。テスト5件追加。
- **E2Eスモークテスト**: PASSED（VCN plan-only: 10 to add, 0 to change, 0 to destroy）