# Galley MCPサーバー フィードバックレポート

**日付**: 2026-02-26
**セッションID**: `a219d915-8038-44d1-8c1e-ee76591a2c04`
**実行シナリオ**: Compute + Autonomous Database (ATP) 検証用構成の構築

---

## 総合評価

ヒアリングからTerraform生成・Plan・Applyまでの一連のフローは概ね機能しており、対話型でOCIインフラを構築できるという価値提案は十分に実証された。一方で、IaC生成の品質やジョブ管理周りにいくつかの改善点が見つかった。

---

## 良かった点

### ヒアリングフロー
- `get_hearing_questions` + `get_hearing_flow` によるフェーズ分けは自然な対話誘導ができた
- `save_answers_batch` による一括保存は効率的
- `complete_hearing` で構造化された要件情報が得られ、次のアーキテクチャ設計へスムーズに移行できた

### アーキテクチャ管理
- `save_architecture` でコンポーネントと接続を宣言的に定義できるのは良い設計
- `export_mermaid` による構成図の即時可視化は顧客への説明に有用

### Terraform実行
- `run_terraform_plan` → エラー → 修正 → 再Plan → `run_terraform_apply` のイテレーションが自然に回せた
- Resource Managerとの統合により、OCI認証やステート管理を意識せずに済む点は大きなメリット

---

## 改善が必要な点

### 1. IaC生成品質（重要度: 高）

`export_iac` が生成するTerraformコードに複数の問題があり、手動修正が必要だった。

| 問題 | 詳細 | 影響 |
|------|------|------|
| **リソース名の構文エラー** | `autonomous_db_(atp)` — 括弧はTerraformリソース名に使用不可 | Plan失敗 |
| **VCNにサブネット未定義** | VCNのみ作成され、Computeが配置できない | Plan失敗 |
| **ネットワーク関連リソース欠落** | Internet Gateway、Route Table、Security Listが未生成 | 実用不可 |
| **image_id が外部変数依存** | data sourceで自動取得すべき | Plan失敗（値未設定） |
| **is_free_tier がfalse** | ヒアリングでFree Tier設定にしたのに反映されず | 意図と不一致 |
| **subnet_id が外部変数** | VCNを自前で作るならサブネットも自前で作るべき | 一貫性の欠如 |

**提案**: 
- リソース名のサニタイズ処理を追加（英数字・アンダースコアのみ許可）
- VCNを含むアーキテクチャの場合、関連するネットワークリソース（IGW、RT、SL、Subnet）を自動生成するテンプレートロジックを導入
- Computeを含む場合、`data "oci_core_images"` を自動追加
- `save_architecture` の config 値（`is_free_tier: true` 等）をTerraform生成に確実に反映

### 2. ジョブ管理とロック制御（重要度: 高）

Applyが部分的に失敗（Compute成功、ATP失敗）した後、セッションがロック状態になり再Applyが長時間不可能だった。

**観測された動作**:
- `run_terraform_apply` が失敗レスポンスを返した後も、セッションが `InfraOperationInProgressError` でロック
- `get_rm_job_status` も `No approval received` エラーで状態確認不可
- 複数回リトライしてもロック解除されず

**提案**:
- RMジョブの完了ステータス（`SUCCEEDED` / `FAILED`）をポーリングし、確定後にロックを自動解放
- ロック解除のタイムアウト機能（例: 5分経過で強制解放）
- `get_rm_job_status` を確実に動作させ、ジョブの進行状況をクライアントに返せるようにする
- セッション単位での手動ロック解除ツール（`unlock_session` 等）の追加を検討

### 3. 部分適用時のリカバリ（重要度: 中）

7リソース中6つが作成成功・1つが失敗というケースで、差分Applyの仕組みが不明瞭。

**提案**:
- Apply失敗時に「作成済みリソース」と「未作成リソース」の一覧を構造化して返す
- 差分のみの再Apply（Terraformのステート依存で自動的にそうなるはずだが）が確実に動く確認
- 部分ロールバック（destroy only failed）のオプション

### 4. Terraform変数のRM自動入力対応（重要度: 中）

`image_id` や `adb_admin_password` のようにRM自動入力されない変数が未設定でPlan失敗した。

**提案**:
- `export_iac` 時に、RM自動入力される変数（`region`, `compartment_ocid`, `tenancy_ocid`）と **それ以外** を明確に分類
- RM自動入力されない必須変数にはデフォルト値を設定するか、`run_terraform_plan` の `variables` パラメータで渡すよう促す
- Compute用のイメージは `data "oci_core_images"` での自動取得をデフォルトパターンにする

### 5. ヒアリング → IaC の情報伝達（重要度: 中）

ヒアリングで収集した情報が `export_iac` の生成コードに十分に反映されていない。

**具体例**:
- ヒアリングで「検証用」→ Free Tier推奨としたが、生成コードでは `is_free_tier = false`
- 「特にこだわりなし」のネットワーク要件 → パブリックサブネット構成を自動選択すべきだが、サブネット自体が未生成

**提案**:
- `complete_hearing` の結果と `save_architecture` の config を `export_iac` が参照し、コードに一貫して反映する仕組み
- ヒアリング回答からのデフォルト値マッピングルールを定義

### 6. UX改善（重要度: 低）

- `export_mermaid` の出力でコンポーネントIDがノード名に使われており可読性が低い → display_nameを使うべき
- `export_mermaid` の接続定義で `compute` → `vcn` のようにservice_typeを参照しているが、コンポーネントIDとの不一致でグラフが正しく描画されない可能性がある

---

## 機能リクエスト

| 優先度 | 機能 | 説明 |
|--------|------|------|
| 高 | IaCテンプレートライブラリ | よくある構成パターン（Compute+ADB、OKE+ADB等）のTerraformテンプレートを内蔵し、`export_iac` の品質を底上げ |
| 高 | `unlock_session` ツール | ジョブロックの手動解放 |
| 中 | Apply後のoutput取得 | 作成されたリソースのIPアドレス、接続文字列等をTerraform outputとして返す |
| 中 | コスト見積もり | アーキテクチャ確定時に月額概算コストを表示 |
| 低 | `validate_architecture` の強化 | OCI固有の制約（Free Tierの上限、シェイプの可用性等）を事前チェック |

---

## まとめ

Galleyのヒアリング→設計→IaC→デプロイの一気通貫フローは、プリセールスのデモ構築を大幅に効率化するポテンシャルがある。最も優先すべきは **IaC生成品質の向上** と **ジョブロック管理の安定化** の2点。これらが解決されれば、「チャットで話すだけでOCI環境が立ち上がる」という体験がより確実に実現できる。

---

## 対応結果
- **対応日**: 2026-02-26
- **ステアリング**: `.steering/20260226-iac-quality-fix/`
- **対応内容の要約**: IaC生成品質（項目1）とUX改善（項目6）を修正。リソース名サニタイズ強化、VCNネットワークリソース自動生成、Computeイメージdata source自動取得、ADB is_free_tierのconfig反映、Mermaid構成図の可読性向上を実装。項目4（Terraform変数のRM自動入力）は前回のRM移行作業で対応済み。項目2（ジョブ管理）・項目3（部分適用リカバリ）は別タスクとして計画予定。