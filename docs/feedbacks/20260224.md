# Galley MCP Server フィードバックレポート

**レポート日:** 2026-02-24
**テスト環境:** Claude.ai（Anthropic MCP連携）
**テストセッション:** `85dd0856-0626-45db-bfb9-7d8400cbaf35`
**テストシナリオ:** 検証用Computeインスタンスの構築（VCN + Subnet + IGW + Security List + Compute）

---

## 1. エグゼクティブサマリー

Galleyのヒアリング→アーキテクチャ設計→IaCエクスポートの基本フローは正常に動作し、プレセールスワークフローの加速という目的に対して有望な基盤が確認できた。一方、Terraformデバッグループ（plan→修正→再plan）の実行において、ファイル編集手段の欠如やテンプレート補完の不足など、実用上のブロッカーがいくつか確認された。

**総合評価: ヒアリング〜設計は実用レベル、IaC生成〜デプロイは要改善**

---

## 2. テスト実施フロー

```
create_session → get_hearing_questions → get_hearing_flow
    → save_answers_batch → complete_hearing
    → save_architecture → export_all
    → export_iac → run_terraform_plan（デバッグループ）
```

---

## 3. 良かった点

### 3.1 ヒアリングフロー

- `get_hearing_questions` + `get_hearing_flow` の組み合わせにより、フェーズ分けされた構造的なヒアリングが自然に実施できた。
- `save_answers_batch` による一括保存が効率的。個別に `save_answer` を繰り返す必要がない。
- `complete_hearing` で要件が構造化されて返却されるため、後続のアーキテクチャ設計への橋渡しがスムーズ。

### 3.2 アーキテクチャ設計

- `save_architecture` で components + connections をまとめて保存でき、設計意図が明確に記録される。
- `export_all` で Markdown サマリー、Mermaid 構成図、Terraform テンプレートが一括生成される点は非常に便利。
- `export_mermaid` の出力はそのままドキュメントに組み込める品質。

### 3.3 OCI CLI統合

- `run_oci_cli` ツールの存在自体は良い設計。環境情報の取得やリソース確認に活用できるポテンシャルがある。

---

## 4. 問題点と改善提案

### 4.1【Critical】セッションTerraformファイルの編集手段がない

**現象:** `export_iac` で生成されたファイルは `/data/sessions/{id}/terraform/` に配置されるが、このディレクトリ内のファイルを更新する手段が存在しない。

- `update_app_code` → `AppNotScaffoldedError`（スキャフォールド済みアプリ専用）
- `run_oci_cli` → `CommandNotAllowedError`（OCI CLIコマンド以外は拒否）
- bash_tool → `/data/` にアクセス不可

**影響:** terraform_debug_loop_text が指示する「エラー→コード修正→再plan」のループが**物理的に実行不可能**。

**改善提案:**
- `update_terraform_file(session_id, file_path, new_content)` のようなTerraformファイル専用の編集ツールを追加する
- または `export_iac` の出力先を外部からも書き込み可能なパスにする

### 4.2【High】Terraform テンプレートのTODOコメント問題

**現象:** `export_iac` が生成する `components.tf` で、subnet / internet_gateway / security_list のリソース定義がTODOコメントアウトのまま出力される。

```hcl
# TODO: No built-in template for service type "subnet"
# resource "oci_subnet" "public_subnet" {
```

**影響:** VCNとComputeのみが実リソースとして定義され、ネットワーク構成の大部分が欠落。そのままではplanすら通らない不完全なコードが生成される。

**改善提案:**
- 主要OCIサービス（subnet, internet_gateway, route_table, security_list, nat_gateway, service_gateway）のTerraformテンプレートをビルトインで実装する
- `save_architecture` で保存したconfigの値（cidr_block, ingress_rules等）を直接HCLに展開する

### 4.3【High】Terraform変数にデフォルト値・tfvarsが未提供

**現象:** `variables.tf` の全変数（region, compartment_id, image_id, subnet_id）にデフォルト値がなく、`terraform.tfvars` も生成されない。

**影響:** `run_terraform_plan` が即座に `Error: No value for required variable` で失敗する。変数ファイルを編集する手段もないため（4.1の問題）、デバッグループが初手で詰む。

**改善提案:**
- `export_iac` 時に `terraform.tfvars.example` をセットで生成する
- `run_terraform_plan` に `-var` や `-var-file` を渡せるオプションを追加する
- セッション作成時にregionやcompartment_idを事前収集し、tfvarsに埋め込む

### 4.4【Medium】subnet_id変数の矛盾

**現象:** テンプレートの `variables.tf` に `subnet_id` 変数が定義されているが、`components.tf` で subnet 自体をリソースとして作成する設計になっている。自分で作るサブネットのIDを外部入力で求める矛盾が生じている。

**改善提案:** アーキテクチャにsubnetコンポーネントが含まれる場合、`subnet_id` 変数は生成せず、`oci_core_subnet.xxx.id` を内部参照するようにする。

### 4.5【Medium】OCI CLI未設定

**現象:** `run_oci_cli` で `Could not find config file at /home/galley/.oci/config` エラー。

**影響:** OCI環境の情報取得（compartment一覧、image一覧など）ができず、Terraformの変数値を自動的に補完できない。

**改善提案:**
- 初回利用時のOCI CLI設定フローをガイドする機能（またはセットアップウィザード）
- Instance Principal や Resource Principal による認証のサポート

### 4.6【Low】`run_terraform_plan` のエラーメッセージのパース支援

**現象:** stderrに複数のエラーが混在して返されるが、構造化されていない。

**改善提案:** エラーを解析して `errors: [{file, line, message, suggestion}]` のような構造で返すと、LLMによる自動修正の精度が向上する。

---

## 5. ツール別評価マトリクス

| ツール | 動作 | 実用性 | 備考 |
|--------|------|--------|------|
| `create_session` | ✅ 正常 | ◎ | — |
| `get_hearing_questions` | ✅ 正常 | ◎ | — |
| `get_hearing_flow` | ✅ 正常 | ◎ | — |
| `save_answer` / `save_answers_batch` | ✅ 正常 | ◎ | batch版が便利 |
| `complete_hearing` | ✅ 正常 | ◎ | 構造化出力が良い |
| `save_architecture` | ✅ 正常 | ○ | connection_typeの種類が不明瞭 |
| `export_all` | ✅ 正常 | ○ | Mermaidのノード参照がIDベースで壊れる場合あり |
| `export_iac` | ✅ 正常 | △ | TODOが多く実用に耐えない |
| `run_terraform_plan` | ✅ 正常 | △ | ファイル編集手段がなくデバッグループ不可 |
| `run_oci_cli` | ⚠️ 設定不足 | ✗ | OCI CLI未設定で利用不可 |
| `update_app_code` | ❌ エラー | ✗ | スキャフォールド未実施で利用不可 |
| `validate_architecture` | 未テスト | — | — |
| `run_terraform_apply` | 未テスト | — | plan通過が前提 |

---

## 6. 優先対応ロードマップ案

### Phase 1（ブロッカー解消）
1. セッションTerraformファイルの編集ツール追加
2. 主要OCIサービスのTerraformテンプレート実装（subnet, igw, route_table, security_list）
3. `terraform.tfvars` の自動生成 or `-var` オプションサポート

### Phase 2（実用性向上）
4. OCI CLI設定のガイド / Instance Principal対応
5. 不要な変数定義の排除（subnet_idの矛盾解消）
6. `export_mermaid` のノード参照修正

### Phase 3（体験向上）
7. Terraformエラーの構造化レスポンス
8. ヒアリング質問のカスタマイズ機能
9. テンプレートストア（`list_templates` / `scaffold_from_template`）の充実

---

## 7. 総括

Galleyの「ヒアリング→設計→IaC」という一気通貫のコンセプトは、プレセールスのアーキテクチャ提案ワークフローに高い親和性がある。特にヒアリングフェーズの完成度は高く、LLMとの対話を通じて自然に要件を構造化できる点は大きな強みである。

最大の課題は、IaC生成以降のフェーズにおけるファイル操作のギャップ。テンプレートの品質向上とファイル編集ツールの追加により、「plan→修正→再plan」のデバッグループが機能するようになれば、エンドツーエンドの自動化が実現できる。

---
## 対応結果
- **対応日**: 2026-02-24
- **ステアリング**: `.steering/20260224-iac-debug-loop/`
- **対応内容の要約**: R1〜R6の全6件を修正。Terraformファイル編集ツール追加（パストラバーサル防止付き）、ネットワーク系6サービスのテンプレート追加、terraform.tfvars.example自動生成、subnet_id/vcn_id変数矛盾のローカル参照解決、OCI CLI未設定時のガイダンス表示、Terraformエラーメッセージの構造化パース。テスト215件全パス、ruff/mypy全クリア。