version: "1.0.0"

# OCI Resource Manager互換のprovider設定
# Resource Managerがtenancy_ocid, region, compartment_ocidを自動注入するため、
# これらの変数にはdefaultを設定しない
provider:
  example: |
    variable "tenancy_ocid" {}
    variable "region" {}
    variable "compartment_ocid" {}

    provider "oci" {
      tenancy_ocid = var.tenancy_ocid
      region       = var.region
    }

# OCI Resource Manager schema.yaml
# スタック作成時の変数入力UIをリッチにする定義ファイル
# 参考: https://docs.oracle.com/ja-jp/iaas/Content/ResourceManager/Concepts/terraformconfigresourcemanager_topic-schema.htm
resource_manager_schema:
  description: |
    schema.yaml はResource Managerスタック作成時の変数入力画面を制御する。
    - groupings: 変数をUIセクションにグループ化
    - variables: 各変数の型・説明・表示制御を定義
    - Resource Managerが自動注入する変数（region, tenancy_ocid, compartment_ocid）は visible: false にする
  example: |
    title: "プロジェクト名"
    description: "プロジェクトの説明"
    schemaVersion: 1.1.0
    version: "20250101"
    locale: "ja"

    groupings:
      - title: "基本設定"
        variables:
          - ${region}
          - ${tenancy_ocid}
          - ${compartment_ocid}
      - title: "アプリケーション設定"
        variables:
          - ${app_name}
          - ${instance_shape}

    variables:
      region:
        type: oci:identity:region:name
        required: true
        description: デプロイ先リージョン
        visible: false
      tenancy_ocid:
        type: string
        required: true
        description: テナンシOCID
        visible: false
      compartment_ocid:
        type: oci:identity:compartment:id
        required: true
        description: コンパートメントOCID
        visible: false
      app_name:
        type: string
        required: true
        default: "myapp"
        description: アプリケーション名
      instance_shape:
        type: enum
        required: true
        default: "VM.Standard.E4.Flex"
        description: インスタンスシェイプ
        enum:
          - "VM.Standard.E4.Flex"
          - "VM.Standard.E5.Flex"
          - "VM.Standard.A1.Flex"
  variable_types:
    - type: string
      description: テキスト入力
    - type: number
      description: 数値入力
    - type: boolean
      description: チェックボックス
    - type: enum
      description: ドロップダウン選択（enum属性で選択肢を定義）
    - type: password
      description: パスワード入力（マスク表示）
    - type: oci:identity:region:name
      description: OCIリージョンピッカー
    - type: oci:identity:compartment:id
      description: コンパートメントピッカー
    - type: oci:core:ssh:publickey
      description: SSH公開鍵入力

resources:
  - resource_type: oci_core_vcn
    description: Virtual Cloud Network
    example: |
      resource "oci_core_vcn" "main" {
        compartment_id = var.compartment_ocid
        cidr_blocks    = ["10.0.0.0/16"]
        display_name   = "galley-vcn"
      }

  - resource_type: oci_core_subnet
    description: サブネット
    example: |
      resource "oci_core_subnet" "public" {
        compartment_id = var.compartment_ocid
        vcn_id         = oci_core_vcn.main.id
        cidr_block     = "10.0.1.0/24"
        display_name   = "public-subnet"
      }

  - resource_type: oci_core_security_list
    description: セキュリティリスト
    example: |
      resource "oci_core_security_list" "main" {
        compartment_id = var.compartment_ocid
        vcn_id         = oci_core_vcn.main.id
        display_name   = "galley-security-list"
      }

  - resource_type: oci_core_instance
    description: Computeインスタンス
    example: |
      resource "oci_core_instance" "app" {
        compartment_id      = var.compartment_ocid
        availability_domain = data.oci_identity_availability_domains.ads.availability_domains[0].name
        shape               = "VM.Standard.E4.Flex"
        display_name        = "galley-app"
      }

  - resource_type: oci_load_balancer_load_balancer
    description: ロードバランサー
    example: |
      resource "oci_load_balancer_load_balancer" "main" {
        compartment_id = var.compartment_ocid
        display_name   = "galley-lb"
        shape          = "flexible"
        subnet_ids     = [oci_core_subnet.public.id]
      }

  - resource_type: oci_database_autonomous_database
    description: Autonomous Database
    example: |
      resource "oci_database_autonomous_database" "main" {
        compartment_id           = var.compartment_ocid
        db_name                  = "galleydb"
        display_name             = "galley-adb"
        cpu_core_count           = 1
        data_storage_size_in_tbs = 1
      }

  - resource_type: oci_containerengine_cluster
    description: OKEクラスター
    example: |
      resource "oci_containerengine_cluster" "main" {
        compartment_id     = var.compartment_ocid
        kubernetes_version = "v1.28.2"
        name               = "galley-oke"
        vcn_id             = oci_core_vcn.main.id
      }

  - resource_type: oci_objectstorage_bucket
    description: Object Storageバケット
    example: |
      resource "oci_objectstorage_bucket" "main" {
        compartment_id = var.compartment_ocid
        namespace      = data.oci_objectstorage_namespace.ns.namespace
        name           = "galley-bucket"
        access_type    = "NoPublicAccess"
      }

  - resource_type: oci_identity_compartment
    description: コンパートメント
    example: |
      resource "oci_identity_compartment" "galley" {
        compartment_id = var.tenancy_ocid
        name           = "galley"
        description    = "Galley application compartment"
      }

  - resource_type: oci_apigateway_gateway
    description: API Gateway
    example: |
      resource "oci_apigateway_gateway" "main" {
        compartment_id = var.compartment_ocid
        endpoint_type  = "PUBLIC"
        subnet_id      = oci_core_subnet.public.id
        display_name   = "galley-apigw"
      }
